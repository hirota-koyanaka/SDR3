# 実装計画書 - バックエンドエンジニア

## 1. 担当範囲概要

### 主要責任
- FastAPI によるRESTful API開発
- Supabaseとの連携実装
- データベース設計・マイグレーション管理
- 認証・認可システム構築
- ビジネスロジック実装
- APIドキュメント作成

### 技術スタック
- **言語**: Python 3.11+
- **フレームワーク**: FastAPI
- **ORM**: SQLAlchemy
- **データベース**: Supabase (PostgreSQL)
- **認証**: Supabase Auth + JWT
- **ファイルストレージ**: Supabase Storage
- **デプロイ**: Vercel Serverless Functions

## 2. プロジェクト構造

```
backend/
├── app/
│   ├── __init__.py
│   ├── main.py                    # FastAPIエントリーポイント
│   ├── api/
│   │   ├── v1/
│   │   │   ├── auth.py           # 認証エンドポイント
│   │   │   ├── users.py          # ユーザー管理
│   │   │   ├── applications.py   # 申請管理
│   │   │   ├── dogs.py           # 犬情報管理
│   │   │   ├── posts.py          # SNS投稿
│   │   │   ├── events.py         # イベント管理
│   │   │   ├── admin.py          # 管理者機能
│   │   │   ├── entries.py        # 入退場管理
│   │   │   └── announcements.py  # お知らせ管理
│   ├── core/
│   │   ├── config.py              # 環境設定
│   │   ├── security.py            # セキュリティ設定
│   │   ├── database.py            # DB接続
│   │   └── supabase.py           # Supabaseクライアント
│   ├── models/                    # SQLAlchemyモデル
│   ├── schemas/                   # Pydanticスキーマ
│   ├── services/                  # ビジネスロジック
│   └── utils/                     # ユーティリティ
├── alembic/                       # DBマイグレーション
├── tests/
├── requirements.txt
└── .env.example
```

## 3. 週次実装計画

### 🚀 Week 0: 環境構築（3日間）

#### Day 1: プロジェクトセットアップ
```bash
# プロジェクト初期化
mkdir backend && cd backend
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 必要パッケージインストール
pip install fastapi uvicorn[standard]
pip install sqlalchemy alembic psycopg2-binary
pip install python-jose[cryptography] passlib[bcrypt]
pip install python-multipart aiofiles
pip install supabase
pip install pytest pytest-asyncio httpx
```

**requirements.txt作成**:
```txt
fastapi==0.109.0
uvicorn[standard]==0.27.0
sqlalchemy==2.0.25
alembic==1.13.1
psycopg2-binary==2.9.9
python-jose[cryptography]==3.3.0
passlib[bcrypt]==1.7.4
python-multipart==0.0.6
aiofiles==23.2.1
supabase==2.3.4
pydantic==2.5.3
pydantic-settings==2.1.0
pytest==7.4.4
pytest-asyncio==0.23.3
httpx==0.26.0
```

#### Day 2: Supabase設定とデータベース設計
```python
# core/config.py
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    # Supabase
    SUPABASE_URL: str
    SUPABASE_ANON_KEY: str
    SUPABASE_SERVICE_KEY: str
    
    # JWT
    SECRET_KEY: str
    ALGORITHM: str = "HS256"
    ACCESS_TOKEN_EXPIRE_MINUTES: int = 30
    
    # CORS
    BACKEND_CORS_ORIGINS: list = ["http://localhost:3000"]
    
    class Config:
        env_file = ".env"

settings = Settings()
```

**データベーススキーマ設計**:
```sql
-- ユーザーテーブル（Supabase Auth連携）
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    auth_id UUID UNIQUE NOT NULL,  -- Supabase Auth ID
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    phone VARCHAR(20),
    address TEXT,
    is_imabari_resident BOOLEAN DEFAULT false,
    residence_years INTEGER,
    status VARCHAR(20) DEFAULT 'pending',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 申請テーブル
CREATE TABLE applications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) NOT NULL,
    name VARCHAR(100) NOT NULL,
    phone VARCHAR(20) NOT NULL,
    address TEXT NOT NULL,
    is_imabari_resident BOOLEAN NOT NULL,
    residence_years INTEGER,
    status VARCHAR(20) DEFAULT 'pending',
    admin_memo TEXT,
    rejected_reason TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    reviewed_at TIMESTAMP,
    reviewed_by UUID REFERENCES admin_users(id)
);

-- 管理者テーブル
CREATE TABLE admin_users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    auth_id UUID UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    role VARCHAR(20) NOT NULL, -- 'admin' or 'super_admin'
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 犬情報テーブル
CREATE TABLE dogs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    breed VARCHAR(100),
    weight DECIMAL(5,2),
    gender VARCHAR(10),
    birth_date DATE,
    personality TEXT,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ワクチン接種記録
CREATE TABLE vaccination_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    dog_id UUID REFERENCES dogs(id) ON DELETE CASCADE,
    vaccine_type VARCHAR(100) NOT NULL,
    vaccination_date DATE NOT NULL,
    certificate_url TEXT,
    next_vaccination_date DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### Day 3: 基本設定とCORS
```python
# main.py
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from app.core.config import settings

app = FastAPI(
    title="里山ドッグラン管理システムAPI",
    version="1.0.0",
    docs_url="/api/docs",
    redoc_url="/api/redoc"
)

app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.BACKEND_CORS_ORIGINS,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

@app.get("/api/health")
async def health_check():
    return {"status": "healthy"}
```

### 📅 Week 1: 認証システムとユーザー管理

#### 月曜日-火曜日: Supabase Auth連携
```python
# core/supabase.py
from supabase import create_client, Client
from app.core.config import settings

supabase: Client = create_client(
    settings.SUPABASE_URL,
    settings.SUPABASE_SERVICE_KEY
)

# services/auth_service.py
from app.core.supabase import supabase
from app.schemas.auth import UserCreate, Token
from fastapi import HTTPException

class AuthService:
    @staticmethod
    async def register_user(user_data: UserCreate):
        try:
            # Supabase Authでユーザー作成
            auth_response = supabase.auth.sign_up({
                "email": user_data.email,
                "password": user_data.password
            })
            
            # DBにユーザー情報保存
            user_record = {
                "auth_id": auth_response.user.id,
                "email": user_data.email,
                "name": user_data.name,
                "phone": user_data.phone,
                "address": user_data.address
            }
            
            db_response = supabase.table("users").insert(user_record).execute()
            return db_response.data[0]
            
        except Exception as e:
            raise HTTPException(status_code=400, detail=str(e))
    
    @staticmethod
    async def login(email: str, password: str):
        try:
            response = supabase.auth.sign_in_with_password({
                "email": email,
                "password": password
            })
            return {
                "access_token": response.session.access_token,
                "refresh_token": response.session.refresh_token,
                "token_type": "bearer"
            }
        except Exception as e:
            raise HTTPException(status_code=401, detail="認証に失敗しました")
```

#### 水曜日: 認証エンドポイント実装
```python
# api/v1/auth.py
from fastapi import APIRouter, Depends, HTTPException
from app.schemas.auth import UserCreate, UserLogin, Token
from app.services.auth_service import AuthService

router = APIRouter(prefix="/api/v1/auth", tags=["認証"])

@router.post("/register", response_model=dict)
async def register(user_data: UserCreate):
    """新規ユーザー登録"""
    return await AuthService.register_user(user_data)

@router.post("/login", response_model=Token)
async def login(credentials: UserLogin):
    """ログイン"""
    return await AuthService.login(
        credentials.email, 
        credentials.password
    )

@router.post("/refresh")
async def refresh_token(refresh_token: str):
    """トークンリフレッシュ"""
    # 実装

@router.post("/logout")
async def logout(token: str = Depends(get_current_user)):
    """ログアウト"""
    # 実装
```

#### 木曜日-金曜日: 認証ミドルウェアとテスト
```python
# core/security.py
from fastapi import Depends, HTTPException, status
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from app.core.supabase import supabase

security = HTTPBearer()

async def get_current_user(credentials: HTTPAuthorizationCredentials = Depends(security)):
    token = credentials.credentials
    try:
        # Supabaseでトークン検証
        user = supabase.auth.get_user(token)
        if not user:
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="Invalid authentication credentials"
            )
        return user
    except Exception:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid authentication credentials"
        )

# 管理者権限チェック
async def require_admin(current_user = Depends(get_current_user)):
    admin = supabase.table("admin_users").select("*").eq("auth_id", current_user.id).execute()
    if not admin.data:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="管理者権限が必要です"
        )
    return admin.data[0]
```

### 📅 Week 2: 申請管理システム

#### 月曜日-火曜日: 申請モデルとスキーマ
```python
# schemas/application.py
from pydantic import BaseModel, EmailStr
from typing import Optional
from datetime import datetime
from enum import Enum

class ApplicationStatus(str, Enum):
    PENDING = "pending"
    APPROVED = "approved"
    REJECTED = "rejected"

class ApplicationCreate(BaseModel):
    email: EmailStr
    name: str
    phone: str
    address: str
    is_imabari_resident: bool
    residence_years: Optional[int]
    dog_info: dict  # 犬の情報
    preferred_date: Optional[datetime]

class ApplicationUpdate(BaseModel):
    status: ApplicationStatus
    admin_memo: Optional[str]
    rejected_reason: Optional[str]

# services/application_service.py
class ApplicationService:
    @staticmethod
    async def create_application(data: ApplicationCreate):
        # ワクチン証明書アップロード処理
        # Supabase Storageを使用
        
        application = {
            "email": data.email,
            "name": data.name,
            "phone": data.phone,
            "address": data.address,
            "is_imabari_resident": data.is_imabari_resident,
            "residence_years": data.residence_years,
            "status": ApplicationStatus.PENDING
        }
        
        result = supabase.table("applications").insert(application).execute()
        
        # 管理者に通知（メール or リアルタイム通知）
        await NotificationService.notify_admin_new_application(result.data[0])
        
        return result.data[0]
```

#### 水曜日: ファイルアップロード機能
```python
# api/v1/files.py
from fastapi import APIRouter, UploadFile, File
from app.core.supabase import supabase
import uuid

router = APIRouter(prefix="/api/v1/files", tags=["ファイル"])

@router.post("/upload/vaccination-certificate")
async def upload_vaccination_certificate(
    file: UploadFile = File(...),
    current_user = Depends(get_current_user)
):
    """ワクチン証明書アップロード"""
    # ファイルサイズチェック（5MB以下）
    if file.size > 5 * 1024 * 1024:
        raise HTTPException(status_code=400, detail="ファイルサイズは5MB以下にしてください")
    
    # ファイルタイプチェック
    allowed_types = ["image/jpeg", "image/png", "application/pdf"]
    if file.content_type not in allowed_types:
        raise HTTPException(status_code=400, detail="JPG、PNG、PDFファイルのみ許可されています")
    
    # Supabase Storageにアップロード
    file_name = f"vaccination/{current_user.id}/{uuid.uuid4()}{file.filename}"
    file_data = await file.read()
    
    response = supabase.storage.from_("documents").upload(
        file_name,
        file_data,
        {"content-type": file.content_type}
    )
    
    # Public URLを取得
    public_url = supabase.storage.from_("documents").get_public_url(file_name)
    
    return {"url": public_url, "file_name": file_name}
```

#### 木曜日-金曜日: 申請API完成とテスト
```python
# api/v1/applications.py
from fastapi import APIRouter, Depends, Query
from typing import List, Optional
from app.schemas.application import ApplicationCreate, ApplicationUpdate

router = APIRouter(prefix="/api/v1/applications", tags=["申請管理"])

@router.post("/", response_model=dict)
async def create_application(data: ApplicationCreate):
    """利用申請作成"""
    return await ApplicationService.create_application(data)

@router.get("/{application_id}")
async def get_application(application_id: str):
    """申請詳細取得"""
    result = supabase.table("applications").select("*").eq("id", application_id).execute()
    if not result.data:
        raise HTTPException(status_code=404, detail="申請が見つかりません")
    return result.data[0]

@router.get("/status/{email}")
async def check_application_status(email: str):
    """申請状況確認（メールアドレスで検索）"""
    result = supabase.table("applications").select("*").eq("email", email).order("created_at", desc=True).execute()
    return result.data

# 管理者用エンドポイント
@router.get("/admin/list")
async def list_applications(
    status: Optional[str] = Query(None),
    limit: int = Query(20, le=100),
    offset: int = Query(0),
    admin_user = Depends(require_admin)
):
    """申請一覧取得（管理者用）"""
    query = supabase.table("applications").select("*")
    
    if status:
        query = query.eq("status", status)
    
    result = query.order("created_at", desc=True).limit(limit).offset(offset).execute()
    return result.data

@router.put("/admin/{application_id}/approve")
async def approve_application(
    application_id: str,
    admin_memo: Optional[str] = None,
    admin_user = Depends(require_admin)
):
    """申請承認"""
    # トランザクション処理
    # 1. 申請ステータス更新
    # 2. ユーザーアカウント作成
    # 3. 承認メール送信
    pass

@router.put("/admin/{application_id}/reject")
async def reject_application(
    application_id: str,
    reason: str,
    admin_user = Depends(require_admin)
):
    """申請却下"""
    pass
```

### 📅 Week 3: 犬情報とユーザー管理

#### 月曜日-火曜日: 犬情報CRUD
```python
# schemas/dog.py
from pydantic import BaseModel
from typing import Optional
from datetime import date

class DogCreate(BaseModel):
    name: str
    breed: Optional[str]
    weight: Optional[float]
    gender: Optional[str]
    birth_date: Optional[date]
    personality: Optional[str]

class VaccinationRecord(BaseModel):
    vaccine_type: str
    vaccination_date: date
    certificate_url: str
    next_vaccination_date: Optional[date]

# api/v1/dogs.py
@router.post("/")
async def create_dog(
    dog_data: DogCreate,
    current_user = Depends(get_current_user)
):
    """犬情報登録"""
    dog = {**dog_data.dict(), "user_id": current_user.id}
    result = supabase.table("dogs").insert(dog).execute()
    return result.data[0]

@router.get("/my-dogs")
async def get_my_dogs(current_user = Depends(get_current_user)):
    """自分の犬一覧取得"""
    result = supabase.table("dogs").select("*, vaccination_records(*)").eq("user_id", current_user.id).execute()
    return result.data

@router.post("/{dog_id}/vaccination")
async def add_vaccination_record(
    dog_id: str,
    record: VaccinationRecord,
    current_user = Depends(get_current_user)
):
    """ワクチン接種記録追加"""
    # 犬の所有者確認
    dog = supabase.table("dogs").select("*").eq("id", dog_id).eq("user_id", current_user.id).execute()
    if not dog.data:
        raise HTTPException(status_code=403, detail="アクセス権限がありません")
    
    vaccination = {**record.dict(), "dog_id": dog_id}
    result = supabase.table("vaccination_records").insert(vaccination).execute()
    return result.data[0]
```

#### 水曜日-金曜日: ユーザープロフィール管理
```python
# api/v1/users.py
@router.get("/profile")
async def get_profile(current_user = Depends(get_current_user)):
    """プロフィール取得"""
    user = supabase.table("users").select("*, dogs(*)").eq("auth_id", current_user.id).execute()
    return user.data[0]

@router.put("/profile")
async def update_profile(
    profile_data: UserProfileUpdate,
    current_user = Depends(get_current_user)
):
    """プロフィール更新"""
    result = supabase.table("users").update(profile_data.dict()).eq("auth_id", current_user.id).execute()
    return result.data[0]

# 管理者用
@router.get("/admin/users")
async def list_users(
    admin_user = Depends(require_admin),
    status: Optional[str] = None,
    limit: int = 20,
    offset: int = 0
):
    """ユーザー一覧取得"""
    query = supabase.table("users").select("*, dogs(*)")
    if status:
        query = query.eq("status", status)
    result = query.limit(limit).offset(offset).execute()
    return result.data
```

### 📅 Week 4-5: SNS機能とイベント管理

#### SNS投稿API
```python
# schemas/post.py
class PostCreate(BaseModel):
    content: str
    hashtags: List[str] = []
    images: List[str] = []
    category: str

# api/v1/posts.py
@router.post("/")
async def create_post(
    post_data: PostCreate,
    current_user = Depends(get_current_user)
):
    """投稿作成"""
    post = {
        "user_id": current_user.id,
        "content": post_data.content,
        "category": post_data.category,
        "status": "pending"  # 管理者承認待ち
    }
    result = supabase.table("posts").insert(post).execute()
    
    # ハッシュタグ処理
    for tag in post_data.hashtags:
        hashtag = supabase.table("hashtags").upsert({"name": tag}).execute()
        supabase.table("post_hashtags").insert({
            "post_id": result.data[0]["id"],
            "hashtag_id": hashtag.data[0]["id"]
        }).execute()
    
    return result.data[0]

@router.get("/feed")
async def get_feed(
    category: Optional[str] = None,
    hashtag: Optional[str] = None,
    limit: int = 20,
    offset: int = 0
):
    """フィード取得"""
    query = supabase.table("posts").select(
        "*, users(name, avatar_url), likes(user_id), comments(count)"
    ).eq("status", "approved")
    
    if category:
        query = query.eq("category", category)
    
    result = query.order("created_at", desc=True).limit(limit).offset(offset).execute()
    return result.data

@router.post("/{post_id}/like")
async def toggle_like(
    post_id: str,
    current_user = Depends(get_current_user)
):
    """いいね切り替え"""
    existing = supabase.table("likes").select("*").eq("post_id", post_id).eq("user_id", current_user.id).execute()
    
    if existing.data:
        # いいね解除
        supabase.table("likes").delete().eq("id", existing.data[0]["id"]).execute()
        return {"liked": False}
    else:
        # いいね追加
        supabase.table("likes").insert({"post_id": post_id, "user_id": current_user.id}).execute()
        return {"liked": True}
```

#### イベント管理API
```python
# api/v1/events.py
@router.post("/admin/events")
async def create_event(
    event_data: EventCreate,
    admin_user = Depends(require_admin)
):
    """イベント作成（管理者）"""
    event = {
        **event_data.dict(),
        "created_by": admin_user["id"]
    }
    result = supabase.table("events").insert(event).execute()
    
    # 全ユーザーに通知
    await NotificationService.notify_new_event(result.data[0])
    
    return result.data[0]

@router.get("/events")
async def get_events(
    start_date: Optional[date] = None,
    end_date: Optional[date] = None
):
    """イベント一覧取得"""
    query = supabase.table("events").select("*, registrations(count)")
    
    if start_date:
        query = query.gte("event_date", start_date)
    if end_date:
        query = query.lte("event_date", end_date)
    
    result = query.order("event_date").execute()
    return result.data

@router.post("/events/{event_id}/register")
async def register_event(
    event_id: str,
    current_user = Depends(get_current_user)
):
    """イベント参加登録"""
    # 定員チェック
    event = supabase.table("events").select("*, registrations(count)").eq("id", event_id).execute()
    if event.data[0]["max_participants"] <= len(event.data[0]["registrations"]):
        raise HTTPException(status_code=400, detail="定員に達しています")
    
    registration = {
        "event_id": event_id,
        "user_id": current_user.id,
        "status": "registered"
    }
    result = supabase.table("event_registrations").insert(registration).execute()
    return result.data[0]
```

### 📅 Week 6-7: QRコード入退場とリアルタイム機能

#### QRコード生成と入退場
```python
# services/qr_service.py
import qrcode
import io
import base64
from datetime import datetime, timedelta
import jwt

class QRService:
    @staticmethod
    async def generate_entry_qr(user_id: str, dog_ids: List[str]):
        """入場用QRコード生成"""
        # 有効期限付きトークン生成
        payload = {
            "user_id": user_id,
            "dog_ids": dog_ids,
            "exp": datetime.utcnow() + timedelta(hours=24),
            "type": "entry"
        }
        
        token = jwt.encode(payload, settings.SECRET_KEY, algorithm=settings.ALGORITHM)
        
        # QRコード生成
        qr = qrcode.QRCode(version=1, box_size=10, border=5)
        qr.add_data(token)
        qr.make(fit=True)
        
        img = qr.make_image(fill_color="black", back_color="white")
        
        # Base64エンコード
        buffer = io.BytesIO()
        img.save(buffer, format="PNG")
        img_str = base64.b64encode(buffer.getvalue()).decode()
        
        return f"data:image/png;base64,{img_str}"

# api/v1/entries.py
@router.post("/check-in")
async def check_in(
    qr_token: str,
    admin_user = Depends(require_admin)
):
    """入場処理（管理者がQRスキャン）"""
    try:
        # トークン検証
        payload = jwt.decode(qr_token, settings.SECRET_KEY, algorithms=[settings.ALGORITHM])
        
        # 重複入場チェック
        existing = supabase.table("entry_logs").select("*").eq("user_id", payload["user_id"]).is_("exit_time", None).execute()
        if existing.data:
            raise HTTPException(status_code=400, detail="既に入場済みです")
        
        # 入場記録作成
        for dog_id in payload["dog_ids"]:
            entry = {
                "user_id": payload["user_id"],
                "dog_id": dog_id,
                "entry_time": datetime.utcnow().isoformat(),
                "checked_by": admin_user["id"]
            }
            supabase.table("entry_logs").insert(entry).execute()
        
        # リアルタイム通知
        await broadcast_entry_update()
        
        return {"status": "success", "message": "入場処理が完了しました"}
        
    except jwt.ExpiredSignatureError:
        raise HTTPException(status_code=400, detail="QRコードの有効期限が切れています")
    except jwt.InvalidTokenError:
        raise HTTPException(status_code=400, detail="無効なQRコードです")

@router.get("/current-visitors")
async def get_current_visitors():
    """現在の利用者一覧"""
    result = supabase.table("entry_logs").select(
        "*, users(name), dogs(name, breed)"
    ).is_("exit_time", None).execute()
    
    return {
        "count": len(result.data),
        "visitors": result.data
    }
```

#### Supabase Realtime連携
```python
# services/realtime_service.py
from app.core.supabase import supabase

class RealtimeService:
    @staticmethod
    async def setup_realtime_listeners():
        """リアルタイムリスナー設定"""
        # 新規投稿の監視
        channel = supabase.channel('posts')
        channel.on(
            'postgres_changes',
            schema='public',
            table='posts',
            event='INSERT',
            callback=handle_new_post
        ).subscribe()
        
        # 入退場の監視
        entry_channel = supabase.channel('entries')
        entry_channel.on(
            'postgres_changes',
            schema='public',
            table='entry_logs',
            event='*',
            callback=handle_entry_update
        ).subscribe()

async def handle_new_post(payload):
    """新規投稿処理"""
    print(f"New post: {payload}")
    # 必要に応じて通知送信

async def handle_entry_update(payload):
    """入退場更新処理"""
    print(f"Entry update: {payload}")
    # 現在の利用者数を更新
```

### 📅 Week 8: お知らせ・営業時間管理

```python
# api/v1/announcements.py
@router.post("/admin/announcements")
async def create_announcement(
    data: AnnouncementCreate,
    admin_user = Depends(require_admin)
):
    """お知らせ作成"""
    announcement = {
        **data.dict(),
        "created_by": admin_user["id"]
    }
    result = supabase.table("announcements").insert(announcement).execute()
    
    # プッシュ通知送信（優先度がhigh以上の場合）
    if data.priority in ["high", "urgent"]:
        await NotificationService.send_push_notification(result.data[0])
    
    return result.data[0]

# api/v1/business_hours.py
@router.put("/admin/business-hours")
async def update_business_hours(
    hours: BusinessHoursUpdate,
    admin_user = Depends(require_admin)
):
    """営業時間更新"""
    for day, time_range in hours.dict().items():
        supabase.table("business_hours").upsert({
            "day_of_week": day,
            "open_time": time_range["open"],
            "close_time": time_range["close"],
            "is_closed": time_range.get("is_closed", False)
        }).execute()
    
    return {"message": "営業時間を更新しました"}

@router.post("/admin/special-holidays")
async def add_special_holiday(
    holiday: SpecialHoliday,
    admin_user = Depends(require_admin)
):
    """特別休業日追加"""
    result = supabase.table("special_holidays").insert(holiday.dict()).execute()
    return result.data[0]
```

### 📅 Week 9-10: パフォーマンス最適化とテスト

#### パフォーマンス最適化
```python
# キャッシュ実装
from functools import lru_cache
import redis
import json

redis_client = redis.Redis.from_url(settings.REDIS_URL)

class CacheService:
    @staticmethod
    async def get_or_set(key: str, func, ttl: int = 300):
        """キャッシュ取得または設定"""
        cached = redis_client.get(key)
        if cached:
            return json.loads(cached)
        
        result = await func()
        redis_client.setex(key, ttl, json.dumps(result))
        return result

# 使用例
@router.get("/events/popular")
async def get_popular_events():
    return await CacheService.get_or_set(
        "popular_events",
        lambda: supabase.table("events").select("*").order("registrations_count", desc=True).limit(5).execute().data,
        ttl=600
    )
```

#### テスト実装
```python
# tests/test_auth.py
import pytest
from httpx import AsyncClient
from app.main import app

@pytest.mark.asyncio
async def test_register():
    async with AsyncClient(app=app, base_url="http://test") as client:
        response = await client.post("/api/v1/auth/register", json={
            "email": "test@example.com",
            "password": "TestPass123!",
            "name": "テストユーザー",
            "phone": "090-1234-5678",
            "address": "愛媛県今治市"
        })
        assert response.status_code == 200
        assert "id" in response.json()

@pytest.mark.asyncio
async def test_login():
    async with AsyncClient(app=app, base_url="http://test") as client:
        response = await client.post("/api/v1/auth/login", json={
            "email": "test@example.com",
            "password": "TestPass123!"
        })
        assert response.status_code == 200
        assert "access_token" in response.json()

# tests/test_applications.py
@pytest.mark.asyncio
async def test_create_application():
    # 申請作成テスト
    pass

@pytest.mark.asyncio
async def test_approve_application():
    # 承認処理テスト
    pass
```

### 📅 Week 11-12: デプロイとドキュメント

#### Vercel デプロイ設定
```python
# api/index.py (Vercel用エントリーポイント)
from app.main import app

# Vercelのサーバーレス関数として動作
handler = app
```

**vercel.json**:
```json
{
  "builds": [
    {
      "src": "api/index.py",
      "use": "@vercel/python"
    }
  ],
  "routes": [
    {
      "src": "/api/(.*)",
      "dest": "api/index.py"
    }
  ]
}
```

#### APIドキュメント自動生成
```python
# main.py に追加
from fastapi import FastAPI
from fastapi.openapi.utils import get_openapi

def custom_openapi():
    if app.openapi_schema:
        return app.openapi_schema
    
    openapi_schema = get_openapi(
        title="里山ドッグラン管理システムAPI",
        version="1.0.0",
        description="愛媛県今治市の里山ドッグラン向けAPI",
        routes=app.routes,
    )
    
    # カスタムタグ
    openapi_schema["tags"] = [
        {"name": "認証", "description": "ユーザー認証関連"},
        {"name": "申請管理", "description": "利用申請の作成と管理"},
        {"name": "犬情報", "description": "犬の登録と管理"},
        {"name": "SNS", "description": "投稿とコミュニティ機能"},
        {"name": "イベント", "description": "イベント管理"},
        {"name": "管理者", "description": "管理者専用機能"}
    ]
    
    app.openapi_schema = openapi_schema
    return app.openapi_schema

app.openapi = custom_openapi
```

## 4. フロントエンドとの連携ポイント

### APIエンドポイント一覧

| エンドポイント | メソッド | 説明 | 認証 |
|---------------|---------|------|------|
| `/api/v1/auth/register` | POST | 新規登録 | 不要 |
| `/api/v1/auth/login` | POST | ログイン | 不要 |
| `/api/v1/applications` | POST | 申請作成 | 不要 |
| `/api/v1/applications/status/{email}` | GET | 申請状況確認 | 不要 |
| `/api/v1/users/profile` | GET | プロフィール取得 | 必要 |
| `/api/v1/dogs` | GET/POST | 犬情報管理 | 必要 |
| `/api/v1/posts/feed` | GET | フィード取得 | 不要 |
| `/api/v1/posts` | POST | 投稿作成 | 必要 |
| `/api/v1/events` | GET | イベント一覧 | 不要 |
| `/api/v1/entries/qr` | GET | QRコード生成 | 必要 |
| `/api/v1/admin/*` | ALL | 管理者機能 | 管理者 |

### レスポンス形式
```json
{
  "data": {},
  "message": "成功メッセージ",
  "status": "success"
}
```

### エラーレスポンス
```json
{
  "detail": "エラーメッセージ",
  "status_code": 400
}
```

## 5. 成果物チェックリスト

### Week 1-2
- [ ] 認証システム完成
- [ ] 申請管理API完成
- [ ] ファイルアップロード機能
- [ ] 基本的なテスト

### Week 3-4
- [ ] ユーザー・犬情報管理完成
- [ ] 管理者機能基本実装
- [ ] データベース設計完了

### Week 5-7
- [ ] SNS機能完成
- [ ] イベント管理完成
- [ ] QRコード入退場実装
- [ ] リアルタイム機能

### Week 8-10
- [ ] お知らせ機能
- [ ] 営業時間管理
- [ ] パフォーマンス最適化
- [ ] 全機能のテスト

### Week 11-12
- [ ] Vercelデプロイ完了
- [ ] APIドキュメント完成
- [ ] 負荷テスト実施
- [ ] セキュリティ監査

## 6. 注意事項

1. **Supabase連携**
   - Service Keyは環境変数で管理
   - Row Level Security (RLS)の設定
   - バックアップ設定確認

2. **セキュリティ**
   - すべてのエンドポイントで入力検証
   - SQLインジェクション対策
   - レート制限実装

3. **パフォーマンス**
   - N+1問題の回避
   - 適切なインデックス設定
   - キャッシュ活用

4. **フロントエンドとの協調**
   - APIドキュメントの随時更新
   - モックデータの提供
   - CORS設定の確認